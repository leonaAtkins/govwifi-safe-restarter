name: "Update Ruby"
description: "Updates Ruby version"

runs:
  using: composite
  steps:

  - name: Set up Ruby
    uses: ruby/setup-ruby@v1
    with:
      ruby-version: env.TARGET_RUBY_VERSION

  - name: Update Ruby versions
    shell: bash
    run: |
      sed -i s/\[0-9\]\\.\[0-9\]\\.\[0-9\]/'env.TARGET_RUBY_VERSION'/ .ruby-version
      cat .ruby-version
      echo "Updated .ruby-version file"
      sed -i s/\[0-9\]\\.\[0-9\]\\.\[0-9\]/'env.TARGET_RUBY_VERSION'/ Dockerfile
      cat Dockerfile
      echo "Updated DockerFile"

  - name: Attempt to run bundle update
    id: bundle-update
    shell: bash
    run: |
      bundle update --ruby
      echo "Updated Gemfile and dependencies"
    continue-on-error: true

  - name: Check on update failure
    shell: bash
    if: steps.bundle-update.outcome != 'success'
    run: |
      echo "Bundle Update didn't work, so have to brute force it"
      echo "Remove and rebuild lock file."
      rm Gemfile.lock
      echo "Gemfile.lock removed"
      bundle install
      echo "Reinstalled Gems and dependencies"
