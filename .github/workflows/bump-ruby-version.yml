name: Update Ruby

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * 0" # Runs Monthly

env:
  RUBY_UPDATED: 'false'

jobs:
  check-ruby:
    runs-on: ubuntu-latest
    steps:
    - name: Check out code
      uses: actions/checkout@v4
    - name: Check Ruby Version
      id: check-ruby
      uses: ./.github/actions/check-ruby
    - name: Setup github branch for Ruby Updates
      id: setup-branch
      if: ${{ env.RUBY_UPDATED }} == 'true'
      uses: ./.github/actions/setup-branch

  upgrade-ruby:
    runs-on: ubuntu-latest
    needs: [check-ruby]
    steps:
    - name: Check out code
      uses: actions/checkout@v4
    -  name: Update Ruby Version
       if: ${{ env.RUBY_UPDATED }} == 'true'
       env:
         TARGET_RUBY_VERSION: ${{ env.TARGET_RUBY_VERSION }}
         BRANCH_NAME: ${{ env.BRANCH_NAME }}
       uses: ./.github/actions/update-ruby
       with:
          ruby-path: '.'

  commit-changes:
    runs-on: ubuntu-latest
    needs: [check-ruby, upgrade-ruby]
    steps:
    - name: Check out code
      uses: actions/checkout@v4
    - name: Raise PR
      env:
         BRANCH_NAME: ${{ env.BRANCH_NAME }}
      uses: ./.github/actions/commit-changes
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}